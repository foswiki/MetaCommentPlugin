"use strict";!function(e){var t={formElements:"textarea, input[type='text'], select"};function n(n,o){var i=this;i.elem=e(n),i.opts=e.extend({},t,o),i.elem.is("form")?i.init():console.error("NaviBlocker: element is not a form: ",n)}n.prototype.init=function(){var t=this;t.initialForm=t.serialize(),t.elem.on("refresh",(function(){t.initialForm=t.serialize()})),e(window).on("beforeunload",(function(e){if(t.hasChanged())return e.preventDefault(),"Are you sure?"}))},n.prototype.hasChanged=function(){var e=this;return!!document.body.contains(e.elem[0])&&!(!e.elem.is(":visible")||e.initialForm===e.serialize())},n.prototype.serialize=function(){return this.elem.find(this.opts.formElements).fieldSerialize()},e.fn.naviBlocker=function(t){return this.each((function(){e.data(this,"NaviBlocker")||e.data(this,"NaviBlocker",new n(this,t))}))},e((function(){e(".naviBlocker").livequery((function(){e(this).naviBlocker()}))}))}(jQuery),function(e){e(".cmtJsonRpcForm").livequery((function(){var t=e(this),n=t.data("message");foswiki.eventClient&&e("<input />").attr({type:"hidden",name:"clientId",value:foswiki.eventClient.id}).prependTo(t),t.on("submit",(function(){var o,i=t.find(".natedit").data("natedit");function r(){t.is(".cmtModalForm")&&(o=t.parent()),t.ajaxSubmit({beforeSubmit:function(){o&&o.dialog("close"),e.blockUI({message:"<h1>"+n+" ...</h1>",fadeIn:0,fadeOut:0})},success:function(t){o&&(o.dialog("destroy"),o.remove()),e.unblockUI(),t.error?e.pnotify({title:"Error",text:t.error.message,type:"error"}):e(".cmtComments").each((function(){var t=e(this).data("MetaComments");t&&(t.elem.find("form[name=addCommentForm]").trigger("reset"),t.reload())}))},error:function(t){var n=e.parseJSON(t.responseText);o&&(o.dialog("destroy"),o.remove()),e.unblockUI(),e.pnotify({title:"Error",text:n.error.message,type:"error"})}})}return i&&e.NatEditor.version?(i.purify(),i.beforeSubmit().then(r)):r(),!1}))}))}(jQuery),function(e){e(document).on("click",".cmtSubscribeButton",(function(){var t=e(this),n=e.extend({subscribed:!1,topic:foswiki.getPreference("WEB")+"."+foswiki.getPreference("TOPIC")},t.data()),o=t.children(".cmtSubscribe"),i=t.children(".cmtUnsubscribe");return n.subscribed?(o.hide(),i.show()):(o.show(),i.hide()),e.blockUI(),foswiki.jsonRpc({namespace:"MetaCommentPlugin",method:n.subscribed?"unsubscribe":"subscribe",params:{topic:n.topic}}).done((function(r){e.unblockUI(),e.pnotify({title:"Success",text:r.result,type:"success"}),n.subscribed?(o.show(),i.hide(),t.data("subscribed",!1)):(o.hide(),i.show(),t.data("subscribed",!0))})).fail((function(t){e.unblockUI(),e.pnotify({title:"Error",text:t.responseJSON.error.message,type:"error"})})),!1}))}(jQuery),function(e){function t(e){return void 0===e.user||e.clientId===foswiki.eventClient.id}function n(t,n){var o=this,i=foswiki.getPreference("WEB")+"."+foswiki.getPreference("TOPIC");o.elem=e(t),o.opts=e.extend({baseTopic:i,topic:i},o.elem.data(),n),o.init()}n.prototype.init=function(){var n=this,o=window.location.hash;n.container=n.elem.find(".cmtCommentsContainer"),n.counter=n.elem.find(".cmtCounter"),o.match(/^#comment\d+\.\d+$/)&&(console.log("scrolling to comment"),e.scrollTo(o.replace(/\./,"\\."),500,{margin:!0,offset:-130,easing:"easeInOutQuad"})),n.elem.on("click",".cmtReply",(function(){var t=e(this).parent().find(".cmtComment:first"),o=e.extend({expand:"comments::replier"},t.data());return n.loadDialog(o),!1})),n.elem.on("click",".cmtEdit",(function(){var t=e(this).parents(".cmtComment:first"),o=e.extend({expand:"comments::updater"},t.data());return n.loadDialog(o),!1})),n.elem.on("click",".cmtDelete",(function(){var t=e(this).parents(".cmtComment:first"),o=e.extend({expand:"comments::confirmdelete"},t.data());return n.loadDialog(o),!1})),n.elem.on("click",".cmtApprove",(function(){var t=e(this).parents(".cmtComment:first"),o=e.extend({expand:"comments::confirmapprove"},t.data());return n.loadDialog(o),!1})),n.elem.on("click",".cmtMark",(function(){var t=e(this),o=t.data("message"),i=t.parents(".cmtComment:first"),r=e.extend({},i.data());return foswiki.jsonRpc({namespace:"MetaCommentPlugin",method:"markComment",params:{topic:n.opts.topic,comment_id:r.commentId},beforeSubmit:function(){e.blockUI({message:"<h1>"+o+" ...</h1>"})},success:function(){e.unblockUI(),t.parent().is(".cmtMarkContainer")?t.parent().remove():t.remove(),i.parent().removeClass("cmtCommentNew cmtCommentUpdated"),n.updateFavicon()},error:function(t){e.unblockUI(),e.pnotify({title:"Error",text:t.error.message,type:"error"})}}),!1})),n.elem.find(".cmtDeleteAll, .cmtApproveAll, .cmtMarkAll, .cmtUnsubscribeAll").on("click",(function(){var t=e(this),o=e.extend({name:t.attr("href").replace(/^#/,"")},t.data());return n.loadDialog(o),!1})),window.setTimeout((function(){n.elem.find(".twistyPlugin").show()}),1),n.updateFavicon(),foswiki.eventClient&&(foswiki.eventClient.bind("commentsave",(function(e){t(e)||n.reload().done((function(){}))})),foswiki.eventClient.bind("commentupdate",(function(e){t(e)||n.reload().done((function(){}))})),foswiki.eventClient.bind("commentdelete",(function(e){t(e)||n.reload()})),foswiki.eventClient.bind("like",(function(o){t(o)||"COMMENT"!==o.data.metaType||n.reload().done((function(){var t=`#comment${o.data.metaId}`.replace(/\./,"\\.")+" .jqLikeButton";e(t).effect("highlight")}))})))},n.prototype.updateFavicon=function(){var e;foswiki.faviconManager&&(e=this.elem.find(".cmtMark").length,foswiki.faviconManager.setText(e||""))},n.prototype.loadDialog=function(t){var n=e.Deferred();return t.name=t.name||this.opts.template,t.topic=t.topic||this.opts.topic,foswiki.loadTemplate(t).done((function(t){var o=e(t.expand);o.hide(),e("body").append(o),o.data("autoOpen",!0).on("dialogopen",(function(){n.resolve(o)}))})),n.promise()},n.prototype.reload=function(){var t=this,n=e.Deferred();return t.container.load(foswiki.getScriptUrl("rest","RenderPlugin","template",{name:t.opts.template,render:"on",topic:t.opts.baseTopic,commentstopic:t.opts.topic,expand:"comments::list",cachecontrol:0}),(function(){e.unblockUI(),t.container.height("auto"),n.resolve(),t.counter.load(foswiki.getScriptUrl("rest","RenderPlugin","template",{name:t.opts.template,render:"on",topic:t.opts.baseTopic,commentstopic:t.opts.topic,expand:"comments::topbar::title::count",cachecontrol:0}))})),n.promise()},e.fn.metaComments=function(t){return this.each((function(){e.data(this,"MetaComments")||e.data(this,"MetaComments",new n(this,t))}))},e((function(){e(".cmtComments").livequery((function(){e(this).metaComments()}))}))}(jQuery);
